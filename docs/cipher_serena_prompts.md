# Cipher → Serena Workflow Prompts

Claude Code で Cipher と Serena を順番に呼び出すためのプロンプト例集です。

## 基本的なワークフロー

### 1. 過去の設計判断を取得してコード修正

```
Cipherを使って「認証システムの設計」について過去の議論を検索し、
その結果を基にSerenaで新しいOAuth2ログイン機能を実装してください。
```

### 2. 特定の機能に関する履歴を調べて改善

```
Cipherで「データベーススキーマ設計」に関する過去の会話を探し、
見つかった設計原則に従ってSerenaで現在のユーザーテーブルを更新してください。
```

### 3. バグ修正の履歴を参照して対応

```
Cipherを使って「パフォーマンスの問題」に関する過去の解決策を調べ、
その知見を活用してSerenaで現在のAPIレスポンス時間を改善してください。
```

## 段階的なプロンプト例

### ステップ1: Cipher での検索
```
@cipher 「APIセキュリティ」について過去の議論や設計判断を検索してください。
特に以下の点について調べてください：
- 認証方式の選択理由
- セキュリティ要件の定義
- 脆弱性対応の履歴
```

### ステップ2: Serena での実装
```
@serena 上記のCipherの検索結果を参考に、以下のタスクを実行してください：
- JWT認証の実装
- レート制限の追加
- セキュリティヘッダーの設定

/src/auth/ ディレクトリ内のファイルを対象に作業してください。
```

## 高度なワークフロー例

### アーキテクチャ変更の実装

```
以下の順序で作業してください：

1. Cipherで「マイクロサービスアーキテクチャ」への移行について
   過去の議論と決定事項を調査

2. 見つかった設計原則とベストプラクティスを整理

3. Serenaを使って、調査結果に基づいて以下を実行：
   - モノリシックAPIの分割
   - サービス間通信の実装
   - 設定ファイルの更新

対象ディレクトリ: /src/services/
```

### テスト戦略の実装

```
Cipherを使って「テスト戦略」に関する過去の決定を調べてください。
特に以下について：
- ユニットテストのカバレッジ目標
- インテグレーションテストの方針
- E2Eテストの範囲

その後、Serenaで調査結果に基づいてテストスイートを改善してください：
- 不足しているテストケースの追加
- テスト設定の最適化
- CI/CDパイプラインのテスト段階の改善
```

## 実用的なコマンド例

### Claude Code での直接実行

```bash
# MCP サーバーを指定して Claude Code を起動
claude-code --mcp-server cipher --mcp-server serena

# または設定ファイルを使用
claude-code --config .claude_code_config.json
```

### スクリプトを使った自動化

```bash
# ワークフロースクリプトの実行
python mcp_workflow.py "database schema design" "update user table structure"

# テストスクリプトでセットアップ確認
python mcp_test.py
```

## トラブルシューティング用プロンプト

### 設定の確認

```
MCPサーバーの設定を確認してください：
1. Cipherが --mcp モードで起動できるか
2. Serena MCP サーバーが uv run で実行できるか
3. .claude_code_config.json の設定が正しいか
```

### エラー処理

```
以下の順序でエラーを調査してください：

1. Cipherで「[エラーメッセージ]」に関する過去の解決策を検索
2. 見つかった解決策を分析
3. Serenaで解決策を実装
4. テストして結果を確認

エラーが再発する場合は、根本原因の分析も含めてください。
```

## ベストプラクティス

### 効率的な検索のコツ
- Cipherでは具体的なキーワードを使用
- 期間や関連者を指定して検索範囲を絞る
- 複数の関連キーワードで検索して情報を補完

### Serena実行時の注意点
- 変更前にバックアップを確認
- 段階的に変更を適用
- 各段階でテストを実行
- 変更履歴を適切にコミット

### ワークフロー最適化
- 頻繁に使用するパターンはスクリプト化
- 結果をドキュメント化して再利用
- 定期的に設定とスクリプトを見直し